name: Build ANGLE
on:
  - pull_request
  - push

jobs:
  build-angle:
    name: ${{matrix.arch}}-${{matrix.os}}-${{matrix.buildType}}
    runs-on: ${{matrix.environment}}

    env:
      vcpkgResponseFile: ${{github.workspace}}/vcpkg-dependencies

    strategy:
      fail-fast: false
      matrix:
        os: [windows, linux, osx]
        arch: [x64]
        buildType: [RelWithDebInfo]
        javaVersion: [8]                    # Earliest supported JDK version.

        include:
          - os: windows
            arch: x64
            environment: windows-2019
            buildType: RelWithDebInfo
            javaVersion: 8

          - os: windows
            arch: x64
            environment: windows-2019
            buildType: Debug
            javaVersion: 8
            
          - os: linux
            arch: x64
            environment: ubuntu-18.04
            buildType: RelWithDebInfo
            displayWrapper: xvfb-run
            javaVersion: 8

          - os: osx
            arch: x64
            environment: macos-latest
            buildType: RelWithDebInfo
            javaVersion: 8

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2
        with:
            submodules: true

      # Would also install these Ubuntu if they weren't installed by other steps: cmake, ninja-build
      - name: Set up Ubuntu packages
        run: sudo apt-get install curl libgl1-mesa-dev libx11-dev xvfb 
        if: ${{startsWith(matrix.environment, 'ubuntu')}}

      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: ${{matrix.javaVersion}}
          architecture: ${{matrix.arch}}

      - name: Run vcpkg
        uses: lukka/run-vcpkg@v2
        with:
          vcpkgTriplet: ${{matrix.arch}}-${{matrix.os}}
          vcpkgArguments: '@${{env.vcpkgResponseFile}}'
          vcpkgDirectory: ${{github.workspace}}/vcpkg
          # Since the cache must be invalidated when content of the response file changes, let's
          # compute its hash and append this to the computed cache's key.
          appendedCacheKey: ${{hashFiles(env.vcpkgResponseFile)}}

      - name: CMake
        uses: lukka/run-cmake@v2
        with:
          cmakeListsOrSettingsJson: CMakeListsTxtAdvanced
          useVcpkgToolchainFile: true
          buildDirectory: ${{runner.workspace}}/out/build
          cmakeAppendedArgs: '-GNinja -DCMAKE_BUILD_TYPE=${{matrix.buildType}} '

      - name: List build directory
        run: ls ${{runner.workspace}}/out/build/

      - name: Run native tests
        run: ${{matrix.displayWrapper || ''}} ${{runner.workspace}}/out/build/angle_easy_tests

      # The classpath separator character is different on Windows (;) versus other platforms (:). One way to avoid
      # using it is to pass * as the classpath, which causes java to put all .jar files in a directory in the classpath.
      # This requires avoiding bash's globbing, which would substitute the * before java saw it.
      #
      # Java puts the current working directory on java.library.path by default on Windows and Linux but not OSX so
      # set it explicitly.
      - name: Run Java tests
        run: |
          set -o noglob
          ${{matrix.displayWrapper || ''}} java -cp * -Djava.library.path=. JavaSmokeTest
        shell: bash
        working-directory: ${{runner.workspace}}/out/build
