name: Build ANGLE
on:
  - pull_request
  - push

jobs:
  build-angle:
    name: ${{matrix.arch}}-${{matrix.os}}-${{matrix.config}}
    runs-on: ${{matrix.environment}}

    env:
        vcpkgResponseFile: ${{github.workspace}}/vcpkg-dependencies

    strategy:
      matrix:
        os: [windows, linux, osx]
        arch: [x64]
        config: [Release]

        include:
          - os: windows
            arch: x64
            environment: windows-2019
            config: Release

          - os: windows
            arch: x64
            environment: windows-2019
            config: Debug

          - os: linux
            arch: x64
            environment: ubuntu-18.04
            config: Release

          - os: osx
            arch: x64
            environment: macos-latest
            config: Release

    steps:
    - name: Checkout source code
      uses: actions/checkout@v2
      with:
          submodules: true

    - name: Install Ubuntu packages
      run: sudo apt-get install mesa-common-dev
      if: ${{startsWith(matrix.environment, 'ubuntu')}}

    - name: Run vcpkg
      uses: lukka/run-vcpkg@v2
      with:
        vcpkgTriplet: ${{matrix.arch}}-${{matrix.os}}
        vcpkgArguments: '@${{env.vcpkgResponseFile}}'
        vcpkgDirectory: '${{github.workspace}}/vcpkg'
        # Since the cache must be invalidated when content of the response file changes, let's
        # compute its hash and append this to the computed cache's key.
        appendedCacheKey: ${{hashFiles(env.vcpkgResponseFile)}}

    - name: CMake
      uses: lukka/run-cmake@v2
      with:
        cmakeListsOrSettingsJson: CMakeListsTxtAdvanced
        useVcpkgToolchainFile: true
        buildDirectory: '${{runner.workspace}}/cmake-build'
        cmakeAppendedArgs: '-GNinja '
